---
description: TypeScript and generator code style guidelines, schema patterns, template conventions, and error handling
globs:
  - "**/*.ts"
  - "**/schema.json"
  - "**/files/**"
alwaysApply: false
---

# Code Style and Best Practices

## TypeScript Style

- Use CommonJS module system
- Export both default and named exports for generators
- Use async/await for asynchronous operations
- Type all function parameters and return values

## Generator Code Style

```typescript
// Generator function signature
export async function generatorName(
  tree: Tree,
  options: GeneratorSchema
) {
  // Implementation
}

// Default export (required)
export default generatorName;
```

## Schema Definition

- Use JSON Schema Draft 07
- Place in `schema.json` file
- Define TypeScript types in `schema.d.ts`
- Use `x-prompt` for interactive prompts
- Mark required fields in `required` array

## Normalization Pattern

Always normalize options before use:

```typescript
const normalizeOptions = (
  options: GeneratorSchema
): GeneratorNormalizedSchema => ({
  ...options,
  optionalField: options.optionalField || defaultValue,
  ignoreFile: '.gitignore',
  tmpl: '', // For __tmpl__ suffix stripping
});
```

## Template File Patterns

- Template files with EJS: Use `__tmpl__` suffix (e.g., `main.tf__tmpl__`)
- Template directory: `files/` subdirectory
- Variable substitution: `<%= variableName %>`
- Conditionals: `<% if (condition) { %> ... <% } %>`
- Always include `tmpl: ''` in normalized options for `__tmpl__` stripping

## Error Handling

- Validate inputs early (in generator function)
- Throw descriptive error messages
- Validate backend project exists before referencing it
- Check for required files (e.g., `project.json`, `main.tf`)

## Testing Style

- Test file: `*.spec.ts` alongside source file
- **For testing utilities (createTreeWithEmptyWorkspace, etc.), see `nx-devkit-utilities.mdc`**
- Test both success and error cases
- Test normalization logic separately
- Verify generated files and project configuration

## File Naming

- **TypeScript source files**: Use camelCase (e.g., `createDependencies.ts`, `fileParser.ts`, `pathResolution.ts`)
- **Generator files**: Use kebab-case to match Nx conventions (e.g., `terraform-backend.ts`, `terraform-module.ts`)
- **Schema files**: `schema.json` and `schema.d.ts`
- **Test files**: Use camelCase matching the source file name (e.g., `createDependencies.spec.ts`, `fileParser.spec.ts`)
- **Templates**: `files/` directory with descriptive names
- **Shared types**: Place in `types.ts` at the root of the `src/` folder

## Constants and Metadata Access

- **Plugin Name**: Always use `PLUGIN_NAME` constant from `constants.ts` instead of hardcoded strings
  ```typescript
  import { PLUGIN_NAME } from '../../constants'; // or '../constants' depending on depth
  ```
- **Metadata Access Pattern**: Always use `PLUGIN_NAME` constant when accessing metadata:
  ```typescript
  const metadata = projectConfig.metadata?.[PLUGIN_NAME];
  const projectType = projectConfig.metadata?.[PLUGIN_NAME]?.projectType;
  const backendProject = projectConfig.metadata?.[PLUGIN_NAME]?.backendProject;
  ```
- **Never use hardcoded strings**: Avoid `metadata['nx-terraform']` - always use `metadata[PLUGIN_NAME]`
- **Constants Location**: `packages/nx-terraform/src/constants.ts` exports `PLUGIN_NAME = 'nx-terraform'`
